<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proceso de Votación</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { 
            background-color: #f8f9fa;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .container { max-width: 800px; }
        .progress-container { margin-bottom: 1.5rem; }
        .progress { border-radius: 0.5rem; }
        .card { 
            border: none;
            border-radius: 0.5rem;
        }
        .step-container { display: none; }
        .step-container.active { display: block; }

        .card-header h1 { font-size: 1.8rem; color: #343a40; }
        .card-title { color: #0056b3; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #0d6efd; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
        .img-preview { 
            max-width: 150px; 
            height: 100px;
            object-fit: cover;
            border: 2px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 4px; 
            display: none; 
        }
        .img-preview.loaded { border-color: #198754; }

        .alert-custom {
            display: flex;
            align-items: center;
            padding: 1rem;
            font-size: 1.1rem;
        }
        .alert-custom .bi {
            font-size: 1.5rem;
            margin-right: 0.75rem;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container py-4">

        <!-- Barra de Progreso -->
        <div class="progress-container">
            <div class="progress" style="height: 25px;">
                <div id="progress-bar" class="progress-bar fw-bold" role="progressbar" style="width: 33%;" aria-valuenow="33" aria-valuemin="0" aria-valuemax="100">Paso 1 de 3</div>
            </div>
        </div>

        <!-- Paso 1: Verificación de Datos -->
        <div id="step1" class="step-container active">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white py-3">
                    <h1>{{ user.get('custom:Comunidad', 'Comunidad no Disponible') }}</h1>
                </div>
                <div class="card-body p-4">
                    <h5 class="card-title">Verificación de Datos</h5>
                    <ul class="list-group list-group-flush mt-3">
                        <li class="list-group-item px-0"><strong>Nombre:</strong> {{ user.get('custom:Nombre', 'No disponible') }}</li>
                        <li class="list-group-item px-0"><strong>RUT:</strong> {{ user.get('custom:Rut', 'No disponible') }}</li>
                    </ul>
                    
                    <h5 class="card-title mt-4">Unidades Asignadas</h5>
                    {% set all_my_units = (pending_units + voted_units)|sort(attribute='unidad') %}
                    {% if all_my_units %}
                        <ul class="list-group list-group-flush mt-2">
                            {% for unit in all_my_units %}
                                <li class="list-group-item d-flex justify-content-between align-items-center px-1 py-3">
                                    <strong class="fw-bold">{{ unit.tipo_unidad }} {{ unit.unidad }}</strong>
                                    {% if unit in pending_units %}
                                        <div class="d-flex align-items-center text-warning">
                                            <i class="bi bi-hourglass-split me-2"></i>
                                            <span class="fw-bold">Pendiente</span>
                                        </div>
                                    {% else %}
                                        <div class="d-flex align-items-center text-success">
                                            <i class="bi bi-check-circle-fill me-2"></i>
                                            <span class="fw-bold">Registrado</span>
                                        </div>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    
                    <!-- Contenedor para la alerta de "votación completada" -->
                    <div id="alert-no-units" class="mt-3"></div>
                </div>
                <div class="card-footer bg-white p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary"><i class="bi bi-box-arrow-left"></i> Cerrar Sesión</a>
                        <button id="continue-step1" class="btn btn-primary" {% if not pending_units %}disabled{% endif %}>Continuar <i class="bi bi-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 2: Validación de Cédula -->
        <div id="step2" class="step-container">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white py-3">
                    <h1>{{ user.get('custom:Comunidad', 'Comunidad no Disponible') }}</h1>
                </div>
                <div class="card-body p-4">
                    <h5 class="card-title">Validación de Identidad</h5>
                    <p class="mt-3">Suba o tome una foto de su cédula para verificar el RUT: <strong>{{ user.get('custom:Rut', 'No disponible') }}</strong></p>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cédula de Identidad (Frontal):</label>
                        <div class="d-flex align-items-center">
                            <div>
                                <input type="file" id="file-upload-front" accept="image/*" style="display: none;">
                                <input type="file" id="file-camera-front" accept="image/*" capture="environment" style="display: none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('file-upload-front').click();"><i class="bi bi-upload"></i> Subir</button>
                                <button type="button" class="btn btn-primary ms-2" onclick="document.getElementById('file-camera-front').click();"><i class="bi bi-camera-fill"></i> Tomar Foto</button>
                            </div>
                            <img id="preview-front" class="img-preview ms-3" src="#" alt="Vista previa frontal" />
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cédula de Identidad (Trasera):</label>
                        <div class="d-flex align-items-center">
                             <div>
                                <input type="file" id="file-upload-back" accept="image/*" style="display: none;">
                                <input type="file" id="file-camera-back" accept="image/*" capture="environment" style="display: none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('file-upload-back').click();"><i class="bi bi-upload"></i> Subir</o>
                                <button type="button" class="btn btn-primary ms-2" onclick="document.getElementById('file-camera-back').click();"><i class="bi bi-camera-fill"></i> Tomar Foto</button>
                            </div>
                            <img id="preview-back" class="img-preview ms-3" src="#" alt="Vista previa trasera" />
                        </div>
                    </div>

                    <button id="validate-rut-btn" class="btn btn-info my-3" disabled><i class="bi bi-shield-check"></i> Validar RUT</button>
                    
                    <div id="loader" class="loader"></div>
                    <div id="validation-result" class="mt-3"></div>
                </div>
                <div class="card-footer bg-white p-3">
                     <div class="d-flex justify-content-between">
                        <button id="prev-step2" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Anterior</button>
                        <button id="next-step2" class="btn btn-primary" disabled>Siguiente <i class="bi bi-arrow-right"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paso 3: Pregunta Final -->
        <div id="step3" class="step-container">
            <div class="card shadow-sm">
                <div class="card-header text-center bg-white py-3">
                    <h1>{{ user.get('custom:Comunidad', 'Comunidad no Disponible') }}</h1>
                </div>
                <div class="card-body p-4">
                    <h5 class="card-title">Votación</h5>
                    <p class="mt-3">¿Estás de acuerdo con el nuevo REGLAMENTO DE COPROPIEDAD?</p>
                    <div class="form-check fs-5 mt-2">
                        <input class="form-check-input" type="radio" name="final-answer" id="final-answer-si" value="si" checked>
                        <label class="form-check-label" for="final-answer-si">Sí, apruebo</label>
                    </div>
                    <div class="form-check fs-5">
                        <input class="form-check-input" type="radio" name="final-answer" id="final-answer-no" value="no">
                        <label class="form-check-label" for="final-answer-no">No, rechazo</label>
                    </div>
                    <div id="final-result" class="mt-4"></div>
                </div>
                <div class="card-footer bg-white p-3">
                    <div class="d-flex justify-content-between">
                        <button id="prev-step3" class="btn btn-outline-secondary"><i class="bi bi-arrow-left"></i> Anterior</button>
                        <button id="save-data" class="btn btn-success"><i class="bi bi-check-circle-fill"></i> Guardar y Finalizar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <script src="{{ url_for('static', filename='js/form.js') }}"></script>
</body>
</html>
